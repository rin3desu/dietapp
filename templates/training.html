{% extends 'layout.html' %}
{% block title %}トレーニング記録 - Diet App{% endblock %}

{% block body_attributes %}
    class="page-background" style="background-image: url('https://images.unsplash.com/photo-1599058917212-d750089bc07e?q=80&w=2069');"
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <h1>トレーニング記録</h1>

    <section>
        <h2>今日のトレーニングを記録する</h2>
        <form action="{{ url_for('training_page') }}" method="post">
            <p>
                <label for="date">日付:</label><br>
                <input type="date" id="date" name="date" required>
            </p>
            <p>
                <label for="part">部位:</label><br>
                <select id="part" name="part" required>
                    <option value="">部位を選択してください</option>
                    <option value="胸">胸</option>
                    <option value="背中">背中</option>
                    <option value="脚">脚</option>
                    <option value="肩">肩</option>
                    <option value="腕">腕</option>
                </select>
            </p>
            <p>
                <label for="event">種目名:</label><br>
                <select id="event" name="event" required>
                    <option value="">---</option>
                    </select>
            </p>
            
            <hr>
            <h3>セットごとの記録</h3>
            <div id="sets-container">
                <div class="set-row">
                    <span>セット1:</span>
                    <input type="number" name="weight_1" placeholder="負荷(kg)" step="0.5" required> kg /
                    <input type="number" name="reps_1" placeholder="回数" required> reps
                </div>
            </div>
            <button type="button" id="add-set-btn">セットを追加</button>
            <hr>

            <button type="submit">この種目を記録する</button>
        </form>
    </section>

    <hr>

    <section>
        <h2>トレーニング履歴</h2>
        
        {# ↓↓↓ この行に並び替えの指示を追加します ↓↓↓ #}
        {% for session_group in sessions | groupby('date') | sort(reverse=True, attribute='grouper') %}
            <h3>{{ session_group.grouper }}</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>部位</th>
                        <th>種目名</th>
                        <th>セット詳細 (負荷 x 回数)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in session_group.list %}
                    <tr>
                        <td>{{ item.part }}</td>
                        <td>{{ item.event }}</td>
                        <td>
                            {% for set in item.sets %}
                                <span>{{ set.weight }}kg x {{ set.reps }}reps</span><br>
                            {% endfor %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>まだトレーニングの記録がありません。</p>
        {% endfor %}
    </section>
</div>

<script>
    // 部位と種目のデータ
    const exercises = {
        '胸': ['ベンチプレス', 'ダンベルフライ', 'インクラインプレス', '腕立て伏せ'],
        '背中': ['懸垂', 'デッドリフト', 'ベントオーバーロウ', 'ラットプルダウン'],
        '脚': ['スクワット', 'レッグプレス', 'ランジ', 'レッグカール'],
        '肩': ['ショルダープレス', 'サイドレイズ', 'フロントレイズ'],
        '腕': ['アームカール', 'トライセプスキックバック', 'ハンマーカール']
    };

    const partSelect = document.getElementById('part');
    const eventSelect = document.getElementById('event');
    const setsContainer = document.getElementById('sets-container');
    const addSetBtn = document.getElementById('add-set-btn');
    let setCount = 1;

    // 部位が選択されたら、種目の選択肢を更新する
    partSelect.addEventListener('change', function() {
        const selectedPart = this.value;
        // 一旦種目リストを空にする
        eventSelect.innerHTML = '<option value="">種目を選択してください</option>';
        
        if (selectedPart && exercises[selectedPart]) {
            exercises[selectedPart].forEach(function(exercise) {
                const option = document.createElement('option');
                option.value = exercise;
                option.textContent = exercise;
                eventSelect.appendChild(option);
            });
        }
    });

    // 「セットを追加」ボタンが押されたら、入力欄を増やす
    addSetBtn.addEventListener('click', function() {
        setCount++;
        const newSetRow = document.createElement('div');
        newSetRow.classList.add('set-row');
        newSetRow.innerHTML = `
            <span>セット${setCount}:</span>
            <input type="number" name="weight_${setCount}" placeholder="負荷(kg)" step="0.5" required> kg /
            <input type="number" name="reps_${setCount}" placeholder="回数" required> reps
        `;
        setsContainer.appendChild(newSetRow);
    });
</script>
{% endblock %}